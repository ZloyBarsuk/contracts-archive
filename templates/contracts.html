{% extends "layout.html" %}

{% block inner_content %}

<div class="govuk-breadcrumbs">
  <ol>
    <li class="">
        <a href="/">Home</a>
    </li>

    <li class="sep">&gt;</li>

    <li class="">
        Search
    </li>
  </ol>
</div>

<div class="grid-row">
  <div class="column-full">
    <h1 class="heading-large">Search Results</h1>
    {% if total == 1 %}
      <p>We found 1 result</p>
    {% else %}
      <p>We found {{total}} results</p>
    {% endif %}
  </div>
</div>

<div class="grid-row">
  <div class="column-one-third">
    {% set querystring = request.args.get('query') or request.args.get('q') or '' %}

    <form method="GET" action="{{url_for('search')}}">
      <div class="form-group">
        <label class="form-label" for="query">Keywords</label>
        <input type="text" class="form-control" name="query" value="{{querystring}}">
      </div>
      <div class="form-group">
        <label class="form-label" for="sort_by">Sort By</label>
        {% if querystring %}
          {% set default_sort = 'relevance' %}
        {% else %}
          {% set default_sort = 'pub_date_desc' %}
        {% endif %}
        <select class="form-control" name="sort_by">
        {% for key, value in sort.items() %}
          {% if request.args.get('sort_by', default_sort) == key %}
          <option value="{{key}}" selected>{{value.title}}</option>
          {% else %}
          <option value="{{key}}">{{value.title}}</option>
          {% endif %}
        {% endfor %}
        </select>
      </div>

      {% if request.args.buying_org %}
        <div class="form-group">
          <label class="form-label" for="full-name-f1">Buying organisation</label>
          <input class="disable form-control" type="text" name="buying_org" value="{{request.args.buying_org}}">
          <i class="remove circle link icon" style="display: none;"></i>
        </div>
      {% endif %}
      {% if request.args.business_name %}
        <div class="form-group">
            <label class="form-label" for="full-name-f1">Awarded Supplier</label>
            <input class="disable form-control" type="text" name="business_name" value="{{request.args.business_name}}">
            <i class="remove circle link icon"></i>
        </div>
      {% endif %}
      {% for name in facets %}
        {% with agg = facets[name] %}
          <div class="form-group">
              <label class="form-label" for="{{name}}">{{agg.title}}</label>
              <select class="form-control" name="{{name}}">
                <option value=""></option>
              {% for opt in agg.buckets|sort_bucket %}
                {% if request.args[name] == opt.key %}
                  <option value="{{opt.key}}" selected>{{opt.key}}</option>
                {% else %}
                  <option value="{{opt.key}}">{{opt.key}}</option>
                {% endif %}
              {% endfor %}
              </select>
          </div>
        {% endwith %}
      {% endfor %}
      <div class="form-group">
          <label class="form-label" for="min_value">Minimum Contract Value (&pound;)</label>
          <input type="number" class="form-control" name="min_value" value="{{request.args.min_value}}"></input>
      </div>
      <div class="form-group">
          <label class="form-label" for="max_value">Maximum Contract Value (&pound;)</label>
          <input type="number" class="form-control" name="max_value" value="{{request.args.max_value}}"></input>
      </div>
      <div class="form-group">
          <label class="form-label" for="publication_date_from">Publication Date</label>
          <p>From</p>
          <input type="text" name="publication_date_from" value="{{request.args.publication_date_from}}" class="form-control needs-datepicker"></input>
          <p>To</p>
          <input type="text" name="publication_date_to" value="{{request.args.publication_date_to}}" class="form-control needs-datepicker"></input>
      </div>
      <div class="form-group">
          <label class="form-label" for="deadline_date_from">Deadline Date</label>
          <p>From<p>
          <input type="text" name="deadline_date_from" value="{{request.args.deadline_date_from}}" class="form-control needs-datepicker"></input>
          <p>To</p>
          <input type="text" name="deadline_date_to" value="{{request.args.deadline_date_to}}" class="form-control needs-datepicker"></input>
      </div>
      <div class="form-group">
          <label class="form-label" for="award_date_from">Awarded Date</label>
          <p>From<p>
          <input type="text" name="award_date_from" value="{{request.args.award_date_from}}" class="form-control needs-datepicker"></input>
          <p>To</p>
          <input type="text" name="award_date_to" value="{{request.args.award_date_to}}" class="form-control needs-datepicker"></input>
      </div>
      <div class="form-group">
        <input type="submit" class="button" value="Update results">
      </div>
    </form>
  </div>

<div class="column-two-thirds">

  {% for contract in contracts %}
    <div>
        <h2 class="heading-small">
          <a href="{{url_for('contract', notice_id=contract.id)}}">{{contract.details.title}}</a>
        </h2>

        <dl class="metadata">
          <dt>Type:</dt>
          <dd>{{contract.type}}</dd>
          <dt>Location:</dt>
          <dd>
            {% if contract.location %}
              {{contract.location.name}}
            {% else %}
              Not specified
            {% endif %}
          </dd>
          <dt>Value:</dt>
          <dd>
            {{contract.min_value|currency}}
            {% if contract.min_value != contract.max_value %}
              - {{contract.max_value|currency}}
            {% endif %}
          </dd>
          {% if request.args.get('sort_by') in ['deadline_date', 'deadline_date_desc'] %}
              <dt>Deadline Date:</dt>
          {% endif %}
          {% if request.args.get('sort_by') in ['award_date', 'award_date_desc'] %}
              <dt>Award Date</dt>
          {% endif %}
        </dl>
        <p>{{contract.details.description|d('No description was provided', True)|truncate(200)|safe}}</p>
    </div>
  {% endfor %}

  <div id="pagenumber">Page {{page}} of {{total_pages}}</div>

    {% if prevlink %}
      <a class="icon item" href="{{prevlink}}">
    {% else %}
      <a class="icon item disabled">
    {% endif %}
      Previous
    </a>
    {% if nextlink %}
      <a href="{{nextlink}}">
    {% else %}
      <a class="disabled">
    {% endif %}
      Next
    </a>
  </div>

</div>
</div>
</div>

{% endblock %}

{% block extra_head %}

  <link rel="stylesheet" type="text/css" href="//data.gov.uk/css/jquery-ui-1.9.2.custom.datepicker.min.css" />
  <script type="text/javascript" src="//data.gov.uk/scripts/vendor/jquery-ui-1.9.2.custom.datepicker.min.js"></script>

  <script type="text/javascript">
    $(function() {
        $(".chosen-select").chosen({allow_single_deselect: true});
        $('.needs-datepicker').datepicker({dateFormat:'yy-mm-dd'});
        $('.disable').attr('disabled','disabled');
        $('.remove.circle.link.icon').css('display', 'block').click(function(){
            $(this).siblings('input').val('');
            $('form').submit();
        });
    });
  </script>
{% endblock %}
